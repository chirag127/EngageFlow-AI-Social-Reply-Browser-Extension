name: CI

# Control when the workflow will run
# Runs on pushes to the main branch and pull requests targeting it.
# Also runs on manual triggers (workflow_dispatch) for testing.
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual triggering

# Default job runner environment
jobs:
  build:
    runs-on: ubuntu-latest

    # Define environment variables for the build process
    env:
      NODE_VERSION: '18.x' # Specify the Node.js version for consistency
      PACKAGE_MANAGER: 'npm' # Using npm as the package manager
      # Define CI variables to detect CI environment
      CI: 'true'
      # Define path for storing test results
      TEST_REPORTS_PATH: 'test-results'

    # Steps to execute in the CI job
    steps:
      # 1. Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache npm dependencies to speed up subsequent runs
          cache: ${{ env.PACKAGE_MANAGER }}

      # 3. Install project dependencies
      # This step uses the specified package manager (npm by default) to install all required dependencies.
      # It utilizes the cache configured in the 'setup-node' step to speed up the process.
      - name: Install Dependencies
        run: ${{ env.PACKAGE_MANAGER }} ci # 'ci' is preferred over 'install' in CI environments for predictable installs

      # 4. Lint and Format Code
      # This step enforces code quality standards using Biome. It checks for linting errors and ensures code formatting.
      # The 'ci' flag ensures it fails the build if any issues are found, promoting clean code.
      - name: Lint and Format with Biome
        run: npm run lint -- --diagnostic-level=warn # Assuming a 'lint' script in package.json that runs Biome

      # 5. Run Unit Tests
      # This step executes the unit tests using Vitest, ensuring core functionality works as expected.
      # It also generates JUnit XML reports for better integration with CI/CD platforms (like GitHub Actions).
      - name: Run Unit Tests
        run: npm test # Assuming a 'test' script in package.json that runs Vitest
        env:
          # Set environment variables for tests if necessary, e.g., for mock API endpoints
          CI: 'true'

      # 6. Upload Test Results
      # Uploads the JUnit XML test reports generated by Vitest. This makes test results easily accessible in the GitHub Actions UI.
      - name: Upload Test Results
        if: always() # Run this step regardless of whether previous steps succeeded or failed
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: ${{ env.TEST_REPORTS_PATH }} # Path where test reports are generated
          retention-days: 7 # Keep artifacts for 7 days

      # 7. Build the Browser Extension
      # This step builds the production-ready version of the browser extension using Vite.
      # This typically compiles TypeScript, bundles JavaScript, and prepares assets for deployment.
      - name: Build Browser Extension
        run: npm run build # Assuming a 'build' script in package.json that runs Vite build
        env:
          NODE_ENV: 'production' # Set Node.js environment to production for optimized builds
          # Add any other necessary build-time environment variables here
          # Example: VITE_API_URL: 'https://api.engagewise.example.com' 

      # 8. Archive Build Artifacts
      # Uploads the built extension files as an artifact. This allows for manual download or further processing (e.g., publishing).
      - name: Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: engage-wise-extension
          path: dist/ # Assumes Vite outputs to a 'dist' directory
          retention-days: 30 # Keep build artifacts for 30 days

      # Optional: Add E2E tests step here if applicable and configured
      # - name: Run End-to-End Tests
      #   run: npm run e2e
      #   env:
      #     CI: 'true'
      #     PLAYWRIGHT_BROWSERS_PATH: 0 # Ensure browsers are installed

      # Optional: Upload E2E test results if E2E tests are run
      # - name: Upload E2E Test Results
      #   if: always() && steps['Run End-to-End Tests'].outcome == 'success'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: e2e-test-results
      #     path: playwright-report/
      #     retention-days: 7
